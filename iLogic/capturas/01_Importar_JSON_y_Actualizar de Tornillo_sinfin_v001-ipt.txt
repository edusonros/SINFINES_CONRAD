Imports System.IO
Imports System.Web.Script.Serialization
'========================================
' 00_Importar_JSON_y_Actualizar
' Lee un JSON genérico (Parametro:Valor en mm)
' y lo aplica por nombre a: IAM + IPTs referenciados.
'========================================


Sub Main()

    Dim jsonPath As String = "C:\edusonros_projects\SINFINES_CONRAD\cfg\tornillo_001.json"
    If Not File.Exists(jsonPath) Then
        MessageBox.Show("No existe el JSON: " & jsonPath, "iLogic")
        Exit Sub
    End If

    '--- Leer JSON
    Dim txt As String = File.ReadAllText(jsonPath)
    Dim ser As New JavaScriptSerializer()
    Dim root = ser.DeserializeObject(txt)

    ' root("global") -> Dictionary
    Dim globals As Object = Nothing
    Try
        globals = DirectCast(root, Dictionary(Of String, Object))("global")
    Catch
        MessageBox.Show("JSON sin nodo 'global'.", "iLogic")
        Exit Sub
    End Try

    Dim dict = DirectCast(globals, Dictionary(Of String, Object))

    '--- 1) Aplicar al propio IAM (si existen parámetros con ese nombre)
    ApplyDictToDocParams(ThisDoc.Document, dict)

    '--- 2) Aplicar a todos los documentos referenciados (IPTs/IAMs)
    ' OJO: si un parámetro no existe en un IPT, se ignora sin romper.
    Dim oAsm As AssemblyDocument = ThisDoc.Document
    For Each refDoc As Document In oAsm.AllReferencedDocuments
        If refDoc.DocumentType = DocumentTypeEnum.kPartDocumentObject _
           Or refDoc.DocumentType = DocumentTypeEnum.kAssemblyDocumentObject Then

            ApplyDictToDocParams(refDoc, dict)

            Try
                refDoc.Update()
                refDoc.Save2(True)
            Catch
                'silencio: si está read-only o no procede
            End Try
        End If
    Next

    '--- Update del IAM al final
    ThisDoc.Document.Update()
    ThisDoc.Document.Save2(True)

    MessageBox.Show("Parámetros aplicados y documentos actualizados.", "iLogic")

End Sub

Private Sub ApplyDictToDocParams(doc As Document, dict As Dictionary(Of String, Object))

    Dim params As Parameters = Nothing
    Try
        If doc.DocumentType = DocumentTypeEnum.kPartDocumentObject Then
            params = DirectCast(doc, PartDocument).ComponentDefinition.Parameters
        ElseIf doc.DocumentType = DocumentTypeEnum.kAssemblyDocumentObject Then
            params = DirectCast(doc, AssemblyDocument).ComponentDefinition.Parameters
        Else
            Exit Sub
        End If
    Catch
        Exit Sub
    End Try

    For Each kvp In dict
        Dim pName As String = kvp.Key
        Dim pValObj As Object = kvp.Value

        ' Convertir a Double
        Dim v As Double
        Try
            v = CDbl(pValObj)
        Catch
            Continue For
        End Try

        ' Intentar: UserParameter primero, si no, cualquier parámetro
        Dim p As Parameter = Nothing

        Try
            p = params.UserParameters.Item(pName)
        Catch
            Try
                p = params.Item(pName)
            Catch
                p = Nothing
            End Try
        End Try

        If p Is Nothing Then Continue For

        Try
            ' Si es longitud: meter "mm". Si es unitless, meter número.
            If p.Units = "mm" Or p.Units = "cm" Or p.Units = "m" Then
                p.Expression = v.ToString(System.Globalization.CultureInfo.InvariantCulture) & " mm"
            ElseIf p.Units = "deg" Then
                p.Expression = v.ToString(System.Globalization.CultureInfo.InvariantCulture) & " deg"
            Else
                p.Expression = v.ToString(System.Globalization.CultureInfo.InvariantCulture)
            End If
        Catch
            'Si está bloqueado por fórmula, ignora
        End Try
    Next

End Sub
